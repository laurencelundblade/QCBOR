name: CI

on: [push, pull_request]

# Fan out for the two compilers
# Fan out disabling on feature at a time -- too slow to do the full combo fan out
jobs:
  main:
    strategy:
      fail-fast: false
      matrix:
        c-compiler: [gcc, clang]

        ifdef: ["", -DQCBOR_DISABLE_NON_INTEGER_LABELS, -DQCBOR_DISABLE_TAGS,
                -DUSEFULBUF_DISABLE_ALL_FLOAT, -DQCBOR_DISABLE_FLOAT_HW_USE,
                -DQCBOR_DISABLE_PREFERRED_FLOAT, -DQCBOR_CONFIG_DISABLE_EXP_AND_MANTISSA,
                -DQCBOR_DISABLE_ENCODE_USAGE_GUARDS, -DQCBOR_DISABLE_INDEFINITE_LENGTH_STRINGS,
                -DQCBOR_DISABLE_INDEFINITE_LENGTH_ARRAYS, -DQCBOR_DISABLE_DECODE_CONFORMANCE ]

        config:
        - os-image: ubuntu-latest
          container: ubuntu:22.04

    name: ${{ matrix.ifdef }} • ${{ matrix.c-compiler }} • ${{ matrix.config.container }}

    runs-on: ${{ matrix.config.os-image }}
    container: ${{ matrix.config.container }}

    steps:
    - uses: actions/checkout@v3

    - name: Install build tools
      run: |
        set -ex
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        apt-get install -y build-essential cmake  ${{ matrix.c-compiler }} 
        echo "CC=${{ matrix.c-compiler }}" >> $GITHUB_ENV
    

    - name: Build QCBOR
      run: |
        set -ex
        make warn CMD_LINE=${{ matrix.ifdef }}

    - name: Run tests
      run: ./qcbortest

  msvc:
    name: ${{ matrix.config.name }} • msvc • windows-latest
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: default
            msvc_defines: ""
          - name: DISABLE_NON_INTEGER_LABELS
            msvc_defines: "/DQCBOR_DISABLE_NON_INTEGER_LABELS"
          - name: DISABLE_TAGS
            msvc_defines: "/DQCBOR_DISABLE_TAGS"
          - name: USEFULBUF_DISABLE_ALL_FLOAT
            msvc_defines: "/DUSEFULBUF_DISABLE_ALL_FLOAT"
          - name: DISABLE_FLOAT_HW_USE
            msvc_defines: "/DQCBOR_DISABLE_FLOAT_HW_USE"
          - name: DISABLE_PREFERRED_FLOAT
            msvc_defines: "/DQCBOR_DISABLE_PREFERRED_FLOAT"
          - name: CONFIG_DISABLE_EXP_AND_MANTISSA
            msvc_defines: "/DQCBOR_CONFIG_DISABLE_EXP_AND_MANTISSA"
          - name: DISABLE_ENCODE_USAGE_GUARDS
            msvc_defines: "/DQCBOR_DISABLE_ENCODE_USAGE_GUARDS"
          - name: DISABLE_INDEF_STRINGS
            msvc_defines: "/DQCBOR_DISABLE_INDEFINITE_LENGTH_STRINGS"
          - name: DISABLE_INDEF_ARRAYS
            msvc_defines: "/DQCBOR_DISABLE_INDEFINITE_LENGTH_ARRAYS"
          - name: DISABLE_UNCOMMON_TAGS
            msvc_defines: "/DQCBOR_DISABLE_UNCOMMON_TAGS"

    env:
      BUILD_TYPE: Release
      ARCH: x64

    steps:
      - uses: actions/checkout@v4

      # Optional: ensures Dev Cmd environment; the VS generator usually finds MSVC without this,
      # but keeping it makes detection deterministic.
      - name: Set up MSVC DevCmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ env.ARCH }}

      - name: Configure (CMake → VS solution)
        shell: bash
        run: |
          cmake -S . -B build ^
            -G "Visual Studio 17 2022" -A ${{ env.ARCH }} \
            -DCMAKE_C_FLAGS="${{ matrix.config.msvc_defines }}" \
            -DCMAKE_CXX_FLAGS="${{ matrix.config.msvc_defines }}"

      - name: Build
        run: cmake --build build --config $env:BUILD_TYPE
        shell: pwsh

      - name: Run tests
        shell: pwsh
        run: |
          $exe = "build/${env:BUILD_TYPE}/qcbortest.exe"
          if (!(Test-Path $exe)) {
            Write-Error "Test binary not found: $exe"
          }
          & $exe

